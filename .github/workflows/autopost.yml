name: Auto Generate Tech Article

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate article
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p _posts

          DATE=$(date +"%Y-%m-%d")
          FILE="_posts/$DATE-tech-article.md"

          echo "{
            \"model\": \"gpt-4o-mini\",
            \"messages\": [
              {
                \"role\": \"user\",
                \"content\": \"Напиши статью на русском про новый гаджет. Формат Jekyll: YAML front matter (title, date, categories, tags), затем markdown текст.\"
              }
            ]
          }" > body.json

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H \"Content-Type: application/json\" \
            -H \"Authorization: Bearer $OPENAI_API_KEY\" \
            -d @body.json)

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > "$FILE"

      - name: Commit and push
        run: |
          git config user.name "AutoBot"
          git config user.email "bot@github.com"
          git add _posts
          git commit -m "Auto article"
          git push
